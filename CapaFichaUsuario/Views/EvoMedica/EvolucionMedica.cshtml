
@{
    ViewBag.Title = "EvolucionMedica";
    Layout = "~/Views/Shared/_Layout5.cshtml";
}


<BR />
<div class="card" id="Medica">
    <div class="card-header text-center">
        <!-- Agrega la clase "text-center" -->
        <div class="row" id="Fila">

            <div class="col-md-7 col-12" style="text-align:left">
                <h1>HOJA  DE  EVOLUCION     MEDICA</h1>
                <h3>Para niños y adolecentes</h3>

            </div>
            <div class="col-md-5 col-12">

                <img id="logo1" class="card-img-top" src="~/Content/img/logoVerde (2).jpeg" height="100" width="1000">
                @*<img id="logoPrint" class="card-img-top" src="~/Content/img/LOGOSin.jpeg" height="100" width="1000">*@
            </div>

        </div>
    </div>
    <div class="card-body">
        @*<div class="row">*@

        <div id="Botones" class="form-group">

            <div class="row" id="miFila">
                <div class="col-md-3 col-12 ">
                    <!-- Agrega un formulario o campos de entrada aquí -->
                    <!-- Botón Guardar -->
                    <button type="button" class="btn btn-primary" onclick="Guardar()"> <i class="fas fa-save"></i> Guardar</button>
                    <br />
                    <br />

                </div>
                <br />
                <div class="col-md-3 col-12 ">
                    <!-- Botón Actualizar -->
                    <button type="button" class="btn btn-success" onclick="Actualizar()"> <i class="fas fa-sync"></i> Actualizar</button>
                    <br />
                    <br />

                </div>
                <br />
                <div class="col-md-3  col-12 ">

                    <!-- Botón limpiar -->
                    <button type="button" class="btn btn-success" onclick="LimpiarFormulario()"> <i class="fas fa-eraser"></i> Limmpiar</button>
                    <br />
                    <br />

                </div>
                <div class="col-md-2 col-12 ">

                    <!-- Botón imprimir -->
                    <button type="button" id="Imp" class="btn btn-dark" onclick="print()"> <i class="fas fa-print"></i> imprimir</button>
                    <br />
                    <br />

                </div>

            </div>

            <div class="row" id="miFila">
                <div class="col-md-3 col-12 ">
                    <label for="txtApellido1" class="col-form-label">Id Historial Clinica </label>
                    <input type="text" style=" border: 1px solid black;"  class="form-control" id="txtIdHistorialClinica" placeholder="Aqui ingrese id" autocomplete="off">
                </div>

                <div class="col-md-3 col-12 ">


                    <!-- Botón asignar -->
                    <button type="button" class="btn btn-info" id="btBuscar"> <i class="fas fa-check"></i> Asignar</button>

                    <br />
                    <br />
                    <br />
                </div>

                <div class="col-md-3 col-12 ">

                    <!-- Botón Buscar -->
                    <button type="button" class="btn btn-info" id="btBuscar2"> <i class="fas fa-search"></i> Buscar</button>
                    <br />
                    <br />
                    <br />
                </div>
                <div class="col-md-3 col-12 ">

                    <input type="text" style=" border: 1px solid black;"  class="form-control" id="txtHojaNo2" placeholder="No hoja" autocomplete="off">
                    <br />
                    <br />
                    <br />
                </div>

            </div>
            <input id="txtIdHistorialClinica" placeholder="Ingrese Id del Usuario" type="hidden">
            <input id="txtId" placeholder="Ingrese Id del historial medica" type="hidden">
        </div>
        <br />

        <div class="row justify-content-end" id="Fila">
            <div class="col-md-5 col-12 d-flex align-items-center">

                <label for="txtHojaNo" class="col-md-2 col-form-label">Hoja No.:</label>
                <input type="text" class="form-control" id="txtHojaNo" value="0" autocomplete="off" readonly>
            </div>
        </div>
        <!-- Segunda fila: 2 columnas -->
        <div class="row" id="Fila">
            <div class="col-md-6 col-12 d-flex align-items-center ">
                <label for="txtApellidos" class="col-md-2 col-form-label">Apellidos:</label>
                <input type="text" class="form-control" id="txtApellidos" autocomplete="off" readonly>
            </div>
            <div class="col-md-6 col-12 d-flex align-items-center ">
                <label for="txtNombres" class="col-md-2 col-form-label">Nombres:</label>
                <input type="text" class="form-control" id="txtNombres" autocomplete="off"readonly>
            </div>
        </div>

        <!-- Tercera fila: 1 columnas -->
        <div class="row" id="Fila">

            <div class="col-md-4 col-12 d-flex align-items-center">
                <label for="txtHistoriaclinicaNo" class="col-md-2 col-form-label">Historia clinica No.:</label>
                <input type="text" class="form-control" id="txtHistoriaclinicaNo" autocomplete="off" readonly>
            </div>
            <div class="col-md-4 col-12 d-flex align-items-center">
                <label for="txtEdad" class="col-md-2 col-form-label">Edad:</label>
                <input type="text" class="form-control" id="txtEdad" autocomplete="off" readonly>
            </div>
            <div class="col-md-4 col-12 d-flex align-items-center">
                <label for="cboSexo2" class="col-md-2 col-form-label">Sexo: </label>

                <input type="text" class="form-control" id="cboSexo2" autocomplete="off" readonly>
            </div>
        </div>
        <div class="row" id="Fila">
            <div class="col-md-12 col-12 d-flex align-items-center">
                <label for="txtDiagnosticos" class="col-md-2 col-form-label">Diagnosticos: </label>
                <textarea class="form-control" id="txtDiagnosticoss" autocomplete="off"></textarea>
            </div>
        </div>

        @*</div>*@
        <hr />
        <div class="row" id="Fila">
            <br />
            <br />
            <br />
            <div class="col-md-4 col-12 d-flex align-items-center">
                <button id="BotonTramiento" type="button" class="btn btn-primary" onclick="abrilModal(null)"> <i class="fas fa-save"></i> AGREGAR EVOLUCION</button>
            </div>
            <div class="col-md-8 col-12 d-flex align-items-center">
                <label for="txtOtros" class="col-md-2 col-form-label" id="txtEvolucionesMeidca">Evoluciones </label>
            </div>
        </div>
        <div class="row" id="Fila">
            <table id="tablaEvoMedica" class="display  cell-border" style="width:100%">
                <thead>

                    <tr>
                        <th> </th>
                        <th> </th>
                        <th> </th>

                    </tr>
                </thead>


                <tbody>
                </tbody>
            </table>
        </div>





    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="FormUsuario" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <!-- Cambio la clase modal-dialog y agrego modal-dialog-centered para centrar el modal -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Datoa de la tabla evolucion medica</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="col-sm-12">
                    <!-- Utilizo una sola columna para contenido -->
                    <input type="hidden" class="form-control" id="txtIdTablaEvolucionMedica" value="0">
                    <input type="hidden" class="form-control" id="txtIdFichaEvolucionMedica2">

                    <label for="Tratamiento" class="form-label">No</label>
                    <input type="text" class="form-control" id="txtcolumna1" autocomplete="off" style="border-color:black">
                    <br />
                    <label for="Duracion" class="form-label">descripcion</label>
                    <input type="text" class="form-control" id="txtcolumna2" autocomplete="off" style="border-color:black">
                    <br />


                </div>
                <div class="row mt-2">
                    <div class="col-12" style="background-color:chartreuse">
                        <div id="mensajeError" class="alert alert-danger" role="alert">
                            A simple danger alert—check it out!
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background-color:lavender">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span>X </span>
                    Cerrar
                </button>
                <button type="button" class="btn btn-primary" onclick="Guardar2()" id="boton">
                    <span class="fas fa-download"></span>
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>


@section scripts{

    <script>
        function cambiarImagen() {
            // Obtén la referencia a la imagen por su ID
            var imagen = document.getElementById("logo1");

            // Cambia el atributo src de la imagen
            imagen.src = "~/Content/img/LOGOSin.jpeg";
      /*      window.print();*/
        }
        function LimpiarFormulario() {
            $("#txtHojaNo").val(0);
            $("#txtHojaNo2").val("");

            $("#txtEdad").val(0);
            $("#txtDiagnosticoss").val("");
            $("#txtHistoriaclinicaNo").val(" ");
            $("#cboSexo2").val(" ");
            $("#txtNombres").val(" ");
            $("#txtApellidos").val(" ");
            $("#txtIdFichaEvolucionMedica2").val(0);

            /*    txtIdTablaEvolucionTecnica */



            mostrar();
            // Repite esto para todos los campos del formulario.

            // También puedes ocultar o cerrar el modal si es relevante.

        }
        function cambiarImagen() {
            // Obtener la referencia de la imagen por su ID
            var imagen = document.getElementById("logo1");

            // Cambiar la fuente (SRC) de la imagen
            imagen.src = "~/Content/img/LOGOSin.jpeg"; // Reemplaza con la nueva ruta de la imagen
        }
         function AsignarDiagnosticos()
        {

            var FichaHisotorialClinica =
            {

                IdHistorialClinica: $("#txtHistoriaclinicaNo").val(),
                Diagnosticos: $("#txtDiagnosticoss").val()
             }

    jQuery.ajax({
        url: '@Url.Action("ActualizarDiagnostivos", "HistoClinico")',
        type: "POST",
        data: JSON.stringify({ objeto: FichaHisotorialClinica }),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {
            $(".modal-body").LoadingOverlay("hide");
            debugger;

            if (data.resultado != 0) {

                //$("#txtHojaNo").val();
                //cambiar();


                ////para poder saber cual es el id usuario
                //$("#btBuscar2").click();


                // La inserción fue exitosa.
                // Puedes realizar cualquier acción adicional que desees aquí.
                // Por ejemplo, borrar los campos del formulario o mostrar un mensaje de éxito.
                swal("Sean asignado correctamente el diagnostica", "success");

            } else {
                swal("Error", data.mensaje, "error")
            }
        },
        error: function (error) {
            $(".modal-body").LoadingOverlay("hide");
            $("#mensajeError").text("Error Ajax");
            $("#mensajeError").show();
        },
        beforeSend: function () {
            $(".modal-body").LoadingOverlay("show", {
                imageResizeFactor: 2,
                text: "Cargando...",
                size: 14
            });
        }
    });
        }







        

        $("#tablaEvoMedica tbody").on("click touchstart", '.btn-eliminar', function (event) {

            event.stopPropagation();
            event.preventDefault();


            var clickedElement = $(event.target);
            var isLi = clickedElement.closest("li").length > 0;

            var filaSeleccionada = isLi ? clickedElement.closest("li") : clickedElement.closest("tr");
            var data = tabladata.row(filaSeleccionada).data();

            swal({
                title: "Esta Seguro?",
                text: "¿Desea eliminar la evolucion medica?",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn-primary",
                confirmButtonText: "Si",
                cancelButtonText: "No",
                closeOnConfirm: true
            },
                function () {

                      jQuery.ajax({
                   url: '@Url.Action("EliminarTablaEvolcucionMedica", "EvoMedica")',
                          type: "POST",
                          data: JSON.stringify({ id: data.IdTablaEvolucionMedica }),
                   dataType: "json",
                   contentType: "application/json; charset=utf-8",
                   success: function (data) {

                       debugger;

                      if (data.resultado) {

                          tabladata.row(filaSeleccionada).remove().draw();
                     } else {

                           swal("No se pudo eliminar", data.mensaje, "error")
                       }
                  },
                   error: function (error) {
                   console.log(error)
                    }
               });




                });

            console.log(data)


        })





        $("#tablaEvoMedica tbody").on("click touchstart", '.btn-editar', function (event) {
            event.stopPropagation();
            event.preventDefault();


            var clickedElement = $(event.target);
            var isLi = clickedElement.closest("li").length > 0;
            var filaSeleccionada = isLi ? clickedElement.closest("li") : clickedElement.closest("tr");

            var data = tabladata.row(filaSeleccionada).data();
            console.log(data);
            abrilModal(data);
        })

        function cambiar()
        {

            var ci = document.getElementById('txtHojaNo').value;
            document.getElementById('txtIdFichaEvolucionMedica2').value = ci;
        }

        function Guardar2()
        {
            var TablaEvolucionMedica = {
                //$("#txtIdTablaEvolucionMedica").val(json.IdTablaEvolucionMedica);
                //$("#txtcolumna1").val(json.columna1);
                //$("#txtcolumna2").val(json.columna2);
                //$("#txtIdFichaEvolucionMedica2").val(json.IdFichaEvolucionMedica);


                IdTablaEvolucionMedica: $("#txtIdTablaEvolucionMedica").val(),
                columna1: $("#txtcolumna1").val(),
                columna2: $("#txtcolumna2").val(),
                IdFichaEvolucionMedica: $("#txtIdFichaEvolucionMedica2").val(),

            }
              jQuery.ajax({
                url: '@Url.Action("GuardarTablaEvolucionMedida", "EvoMedica")',
                type: "POST",
                  data: JSON.stringify({ objeto: TablaEvolucionMedica }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    $(".modal-body").LoadingOverlay("hide");



                    if (TablaEvolucionMedica.IdTablaEvolucionMedica == 0) {

                        if (data.resultado != 0) {
                            debugger;
                            cambiar();

                            $("#txtIdFichaEvolucionMedica2").val($("#txtHojaNo").val());
                            // para poder saber cual es el id usuario
                            $("#btBuscar2").click();
                            //Tratamiento.IdTablaTratamiento = data.resultado;
                            //tabladata.row.add(Tratamiento).draw(false);
                            $("#FormUsuario").modal("hide");

                        } else {
                            $("#mensajeError").text(data.mensaje);
                            $("#mensajeError").show();
                        }


                    } else {

                        if (data.resultado) {
                            $("#btBuscar2").click();
                            $("#FormUsuario").modal("hide");

                        } else {
                            $("#mensajeError").text(data.mensaje);
                            $("#mensajeError").show();
                        }
                    }

                  },
                  error: function (error) {
                      $(".modal-body").LoadingOverlay("hide");
                      $("#mensajeError").text("Error Ajax");
                      $("#mensajeError").show();
                  },
                  beforeSend: function () {
                      $(".modal-body").LoadingOverlay("show", {
                          imageResizeFactor: 2,
                          text: "Cargando...",
                          size: 14
                      })
                  }

            });

        }


        function mostrar()
        {
             var nuevaurl = '@Url.Action("ListarTablaEvolucionMedica2", "EvoMedica")' +
            "?IdFichaEvolucionMedica=" + $("#txtHojaNo").val()
            tabladata.ajax.url(nuevaurl).load();
        }


         var Url = '@Url.Action("ListarTablaEvolucionMedica2","EvoMedica")' +
             "?IdFichaEvolucionMedica=" + $("#txtHojaNo").val() ,


             tabladata = $("#tablaEvoMedica").DataTable({
            "paging": false,
                 "searching": false, // Esto desactiva el buscador
                 "info": false,
                 "dom": '<"top"i>rt<"bottom"flp><"clear">',//quitar url

                        responsive: true,
                        ordering: false,
                        "ajax": {
                            url:Url,
                            type: "GET",
                            dataType: "json"
                        },
                        "columns":
                        [

                                { "data": "columna1" },
                                { "data": "columna2" },



                            {
                                "defaultContent": ' <button type="button" class="btn btn-outline-secondary btn-sm btn-editar"><i class="fas fa-pen"></i></button>' +
                                    ' <button type="button" class="btn btn-outline-dark btn-sm ms-2 btn-eliminar"><i class="fas fa-trash"></i></button>',
                                "orderable": false,
                                "searchable": false,
                                "width": "90px"
                            }
                        ],
                        "language": {
                            "url": "https://cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json"
            },
            retrieve: true,
            paging: false
        });
            $.fn.dataTable.ext.errMode = 'throw';






        function abrilModal(json) {

            $("#txtIdTablaEvolucionMedica").val(0);
            $("#txtcolumna1").val(" ");
            $("#txtcolumna2").val(" ");



            debugger;



            $("#mensajeError").hide();


            if (json != null) {

                $("#txtIdTablaEvolucionMedica").val(json.IdTablaEvolucionMedica);
                $("#txtcolumna1").val(json.columna1);
                $("#txtcolumna2").val(json.columna2);

                $("#txtIdFichaEvolucionMedica2").val(json.IdFichaEvolucionMedica);

            }

            $("#FormUsuario").modal("show");
        }


        function Actualizar()
        {

            var FichaEstudio =
            {
             IdFichaEvolucionMedica: $("#txtHojaNo").val(),
                IdHistorialClinica: $("#txtHistoriaclinicaNo").val(),
                Diagnostico: $("#txtDiagnosticoss").val(),

             }

    jQuery.ajax({
        url: '@Url.Action("Actualizar", "EvoMedica")',
        type: "POST",
        data: JSON.stringify({ objeto: FichaEstudio }),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {
            $(".modal-body").LoadingOverlay("hide");
            debugger;

            if (data.resultado != 0) {

                $("#txtHojaNo").val();
                cambiar();


                //para poder saber cual es el id usuario
                $("#btBuscar2").click();


                // La inserción fue exitosa.
                // Puedes realizar cualquier acción adicional que desees aquí.
                // Por ejemplo, borrar los campos del formulario o mostrar un mensaje de éxito.
                swal("Los cambios se guardaron con exito", "success");

            } else {
                swal("Error", data.mensaje, "error")
            }
        },
        error: function (error) {
            $(".modal-body").LoadingOverlay("hide");
            $("#mensajeError").text("Error Ajax");
            $("#mensajeError").show();
        },
        beforeSend: function () {
            $(".modal-body").LoadingOverlay("show", {
                imageResizeFactor: 2,
                text: "Cargando...",
                size: 14
            });
        }
    });
        }

          $(function () {
            $("#btBuscar2").on("click", function () {



                jQuery.ajax({
                    url: '@Url.Action("VistaFichaEvolucionMedica2", "EvoMedica")' +
                        "?IdFichaEvolucionMedica=" + $("#txtHojaNo2").val() ,
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        debugger;
                    /*    txtHojaNo txtApellidos txtNombres txtHistoriaclinicaNo txtEdad cboSexo2 txtDiagnosticos*/
                        var ob = data.resultado;
                        $("#txtHojaNo").val(ob.IdFichaEvolucionMedica),
                            $("#txtApellidos").val(ob.PrimerApellido + ' ' + ob.SegundoApellido),
                            $("#txtNombres").val(ob.PrimerNombre + ' ' + ob.SegundoNombre),
                            $("#txtHistoriaclinicaNo").val(ob.IdHistorialClinica),
                            $("#txtEdad").val(ob.Edad),
                            $("#cboSexo2").val(ob.Sexo),
                            $("#txtDiagnosticoss").val(ob.Diagnostico)


                        mostrar();
                        cambiar();


                    }

                });

            });

        }
            )




        function Guardar()
        {
    debugger;
    var FichaEvolucionMedica = {
        IdHistorialClinica: $("#txtHistoriaclinicaNo").val(),
        Diagnostico: $("#txtDiagnosticoss").val(),


          }

    jQuery.ajax({
        url: '@Url.Action("GuardarFichaEvolucionMedica", "EvoMedica")',
        type: "POST",
        data: JSON.stringify({ objeto: FichaEvolucionMedica }),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {
            $(".modal-body").LoadingOverlay("hide");
            debugger;

            if (data.resultado != 0) {


                //$("#txtHojaNo").val(data.resultado);

                //cambiar();
                //// Set the values of txt1oAPELLIDO and txtNOMBRE
                //$("#txt1oAPELLIDO").val($("#txtPrimerApellidob").val());
                //$("#txtNOMBRE").val($("#txtPrimerNombreb").val());

                // //para poder saber cual es el id usuario
                //$("#btBuscar2").click();

                

                // La inserción fue exitosa.
                // Puedes realizar cualquier acción adicional que desees aquí.
                // Por ejemplo, borrar los campos del formulario o mostrar un mensaje de éxito.
                swal("Se guardo con exito", "success");
                LimpiarFormulario();

            } else {
                swal("Error", data.mensaje, "error")
            }
        },
        error: function (error) {
            $(".modal-body").LoadingOverlay("hide");
            $("#mensajeError").text("Error Ajax");
            $("#mensajeError").show();
        },
        beforeSend: function () {
            $(".modal-body").LoadingOverlay("shsow", {
                imageResizeFactor: 2,
                text: "Cargando...",
                size: 14
            });
        }
    });
        }






                      $(function () {
            $("#btBuscar").on("click", function () {

                IdUsuario: $("#txtIdUsuario").val()

                jQuery.ajax({
                    url: '@Url.Action("VistaFichaEvolucionMedica", "EvoMedica")' +
                        "?IdHistorialClinica=" + $("#txtIdHistorialClinica").val() ,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        debugger;

                        var ob = data.resultado;
                  /*     txtApellidos txtNombres txtHistoriaclinicaNo txtEdad cboSexo2 txtDiagnosticos*/
                        $("#txtHistoriaclinicaNo").val(ob.IdHistorialClinica),
                            $("#txtNombres").val(ob.SegundoNombre + ' ' + ob.PrimerNombre),
                            $("#txtApellidos").val(ob.SegundoApellido + ' ' + ob.PrimerApellido ),

                            $("#txtEdad").val(ob.Edad),
                            $("#cboSexo2").val(ob.Sexo)




                    }

                });

            });

        }
        )
    </script>

}



