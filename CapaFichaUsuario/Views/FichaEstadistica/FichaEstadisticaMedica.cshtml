
@{
    ViewBag.Title = "FichaEstadisticaMedica";
    Layout = "~/Views/Shared/_Layout5.cshtml";
}

<div class="card" >
    <div class="card-header text-center">
        <!-- Agrega la clase "text-center" -->
        <h1>CRINAM - FUNDABIEM</h1>
        <h3>ESTADISTICA DIARIA</h3>
    </div>
    <div class="card-body">
        @*<div class="row">*@

        <div id="Botones" class="form-group">

            <div class="row" id="miFila">
                <div class="col-md-3 col-12 ">
                    <!-- Agrega un formulario o campos de entrada aquí -->
                    <!-- Botón Guardar -->
                    <button type="button" class="btn btn-primary" onclick="Guardar()"> <i class="fas fa-save"></i> Guardar</button>
                    <br />
                    <br />

                </div>
                <br />
                <div class="col-md-3 col-12 ">
                    <!-- Botón Actualizar -->
                    <button type="button" class="btn btn-success" onclick="Actualizar()"> <i class="fas fa-sync"></i> Actualizar</button>
                    <br />
                    <br />

                </div>
                <br />
                <div class="col-md-3  col-12 ">

                    <!-- Botón limpiar -->
                    <button type="button" class="btn btn-success" onclick="LimpiarFormulario()"> <i class="fas fa-eraser"></i> Limpiar</button>
                    <br />
                    <br />

                </div>
                <div class="col-md-2 col-12 ">

        
                    <button type="button" class="btn btn-dark" onclick="print()"> <i class="fas fa-print"></i> imprimir</button>
                    <br />
                    <br />

                </div>

            </div>
          
            <div class="row" id="miFila">
                <div class="col-md-3 col-12 ">
                    <label for="txtApellido1" class="col-form-label">Fecha para buscar</label> 
                    <input type="text" style=" border: 1px solid black;"placeholder="Fecha de busqueda" class="form-control" id="txtFecha2" autocomplete="off">
                    <input type="hidden" class="form-control" id="txtIdEstadistica" autocomplete="off">
                </div>

                <div class="col-md-3 col-12 ">


                    <!-- Botón Buscar -->
                    <button type="button" class="btn btn-info" id="btBuscar2"> <i class="fas fa-search"></i> Buscar</button>
                    <br />
                    <br />
                    <br />
                </div>



            </div>
            <input id="txtIdHistorialClinica" placeholder="Ingrese Id del Usuario" type="hidden">
            <input id="txtId" placeholder="Ingrese Id del historial medica" type="hidden">
        </div>
        <br />

        <div class="row" id="Fila">

            <div class="col-md-4 col-12 d-flex align-items-center ">
            
                <label class="col-md-2 col-form-label">Medico :</label>
                <select id="cboEmpleado2" class="form-control" aria-label="Default select exampl" >
                </select>
            </div>
        </div>
        <!-- Segunda fila: 2 columnas -->
        <div class="row" id="Fila">
            <div class="col-md-4 col-12 d-flex align-items-center ">
                <label for="txtApellidos" class="col-md-2 col-form-label">Fecha:</label>
                <input type="text" class="form-control" id="txtFecha" autocomplete="off">
            </div>
            <div class="col-md-4 col-12 d-flex align-items-center ">
                <label class="col-md-2 col-form-label">Horario de : </label>
                <input type="text" class="form-control" id="txtInicio" autocomplete="off">
            </div>
            <div class="col-md-4 col-12 d-flex align-items-center ">
                <label for="txtNombres" class="col-md-2 col-form-label">a </label>
                <input type="text" class="form-control" id="txtFin" autocomplete="off">
                <label for="txtNombres" class="col-md-2 col-form-label"> horas.</label>
            </div> 
        </div>

      
        @*</div>*@
        <hr />
        <div class="row" id="Fila">
            <br />
            <br />
            <br />
            <div class="col-md-4 col-12 d-flex align-items-center">
                <button id="BotonTramiento" type="button" class="btn btn-primary" onclick="abrilModal(null)"> <i class="fas fa-save"></i> AGREGAR </button>
            </div>
            
        </div>
        <div class="row" id="Fila">
            <table id="tablaEstadistica" class="display  cell-border" style="width:100%">
                <thead>

                    <tr>

                        <th class="col-no">No</th>
                        <th class="col-nombre">Nombre</th>
                        <th class="col-registro">Registro</th>
                        <th class="col-edad">Edad</th>
                        <th class="col-sexo">Sexo</th>
                        <th class="col-procedencia">Procedencia</th>
                        <th class="col-consulta">Consulta</th>
                        <th class="col-diagnostico">Diagnostico</th>
                        <th class="col-comentario">Comentario</th>
                        <th class="col-con-trasl">Con. Trasl</th>
                        <th class="col-ra-ortesis">Ra.Ortesis</th>
                        <th style="width: 5%;"></th>

                    </tr>
                </thead>


                <tbody>
                </tbody>
            </table>
        </div>





    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="FormUsuario" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <!-- Cambio la clase modal-dialog y agrego modal-dialog-centered para centrar el modal -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Datos de estadistica Diaria</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="col-sm-12">
                    <!-- Utilizo una sola columna para contenido -->

                    <input type="hidden" class="form-control" id="txtIdEstadistica2" autocomplete="off" style="border-color:black">
                    <input type="hidden" class="form-control" id="txtIdTabEstadistica" autocomplete="off" style="border-color:black">
                    <label class="form-label">No</label>
                    <input type="text" class="form-control" id="txtNo" autocomplete="off" style="border-color:black">
                    <br />
                    <label class="form-label">Historial</label>
                    <select id="cboHistorial" class="form-select" aria-label="Default select exampl" style="border-color:black">
                    </select>
                    <br />
                    <label class="form-label">Consulta</label>
                    <select id="cboConsulta" class="form-select" aria-label="Default select exampl" style="border-color:black">
                        <option value="1">1</option>
                        <option value="cc">cc</option>
                        <option value="ccc">ccc</option>


                    </select>
                    <br />
                    <label class="form-label">Diagnostico</label>
                    <div class="col-sm-7">

                        <textarea class="form-control" id="txtDiagnostico" autocomplete="off"></textarea>
                        <br />
                    </div>
                    <label class="form-label">Comentario</label>
                    @*<input type="text" class="form-control" id="txtComentario" autocomplete="off">*@
                <div class="col-sm-7">
                    <textarea class="form-control" id="txtComentario" autocomplete="off"></textarea>
                    <br />
                </div>
                        <label class="form-label">Cons. Tral</label>
                        <select id="cboConsTral" class="form-select" aria-label="Default select exampl" style="border-color:black">
                            <option value="Si">Si</option>
                            <option value="NO">NO</option>


                        </select>
                        <br />
                        <label class="form-label">Ra Ortesis</label>
                        <select id="RaOrtesis" class="form-select" aria-label="Default select exampl" style="border-color:black">
                            <option value="Si">Si</option>
                            <option value="NO">NO</option>


                        </select>
                        <br />


                    </div>
                    <div class="row mt-2">
                        <div class="col-12" style="background-color:chartreuse">
                            <div id="mensajeError" class="alert alert-danger" role="alert">
                                A simple danger alert—check it out!
                            </div>
                        </div>
                    </div>
                </div>
            <div class="modal-footer" style="background-color:lavender">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span>X </span>
                    Cerrar
                </button>
                <button type="button" class="btn btn-primary" onclick="Guardar2()" id="boton">
                    <span class="fas fa-download"></span>
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>

        var tabladata;
        var filaSeleccionada;
        $("#txtFecha2").datepicker({
            dateFormat: 'yy/mm/dd',
            monthNames: ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'],
            monthNamesShort: ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'],
            dayNames: ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'],
            dayNamesShort: ['dom', 'lun', 'mar', 'mié', 'jue', 'vie', 'sáb'],
            dayNamesMin: ['D', 'L', 'M', 'Mi', 'J', 'V', 'S'],


        }).datepicker('setDate', new Date());
        $("#txtFecha").datepicker({
            dateFormat: 'yy/mm/dd',
            monthNames: ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'],
            monthNamesShort: ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'],
            dayNames: ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'],
            dayNamesShort: ['dom', 'lun', 'mar', 'mié', 'jue', 'vie', 'sáb'],
            dayNamesMin: ['D', 'L', 'M', 'Mi', 'J', 'V', 'S'],
        }).datepicker('setDate', new Date());

        $("#cboEmpleado2").val($("#cboEmpleado2 option:first").val());

        function LimpiarFormulario() {

            //txtIdEstadistica2 txtFin txtInicio txtFecha cboEmpleado txtIdEstadistica
            $("#txtIdEstadistica2").val(0);
            $("#txtFin").val("");
            $("#txtInicio").val("");
            $("#txtFecha").val("");
            $("#txtFecha2").val("");
            $("#cboEmpleado2").val(0);
            $("#txtIdEstadistica").val(0);
           
           
            mostrar();
           

        }

     
            



            $("#tablaEstadistica tbody").on("click touchstart", '.btn-eliminar', function (event) {

                event.stopPropagation();
                event.preventDefault();


                var clickedElement = $(event.target);
                var isLi = clickedElement.closest("li").length > 0;

                var filaSeleccionada = isLi ? clickedElement.closest("li") : clickedElement.closest("tr");

                var data = tabladata.row(filaSeleccionada).data();

            swal({
                title: "Esta Seguro?",
                text: "¿Desea eliminar al usuario de la estadistica del presente dia?",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn-primary",
                confirmButtonText: "Si",
                cancelButtonText: "No",
                closeOnConfirm: true
            },
                function () {
                    swal.close();
                      jQuery.ajax({
                   url: '@Url.Action("EliminarTablaEstadistica", "FichaEstadistica")',
                          type: "POST",
                          data: JSON.stringify({ id: data.IdTabEstadistica }),
                   dataType: "json",
                   contentType: "application/json; charset=utf-8",
                   success: function (data) {

                       debugger;

                      if (data.resultado) {

                          tabladata.row(filaSeleccionada).remove().draw();
                     } else {

                           swal("No se pudo eliminar", data.mensaje, "error")
                       }
                  },
                   error: function (error) {
                   console.log(error)
                    }
               });




                });

            console.log(data)


        })


        $("#tablaEstadistica tbody").on("click touchstart", '.btn-editar', function (event)
        {
            event.stopPropagation();
            event.preventDefault();


            var clickedElement = $(event.target);
            var isLi = clickedElement.closest("li").length > 0;

            var filaSeleccionada = isLi ? clickedElement.closest("li") : clickedElement.closest("tr");
            var data = tabladata.row(filaSeleccionada).data();


            console.log(data);
            abrilModal(data);
        });

         function Guardar2()
        {
            var TablaEstadistica= {
                //$("#txtIdTablaEvolucionMedica").val(json.IdTablaEvolucionMedica);
                //$("#txtcolumna1").val(json.columna1);
                //$("#txtcolumna2").val(json.columna2);
                //$("#txtIdFichaEvolucionMedica2").val(json.IdFichaEvolucionMedica);
                /*txtIdEstadistica2 txtNo cboHistorial cboConsulta txtDiagnostico txtComentario cboConsTral*/
                IdTabEstadistica: $("#txtIdTabEstadistica").val(),
                IdEstadisticaDiaria: $("#txtIdEstadistica2").val(),
                no: $("#txtNo").val(),
                Diagnostico: $("#txtDiagnostico").val(),
                Consulta: $("#cboConsulta").val() ,
                ConsTras: $("#cboConsTral").val(),
                RaOrtesis: $("#RaOrtesis").val(),
                Comentario: $("#txtComentario").val(),
                OFichaHistorialClinica: {
                    IdHistorialClinica: $("#cboHistorial option:selected").val(),
                    Nombre: $("#cboHistorial option:selected").text()
                },
            }
              jQuery.ajax({
                url: '@Url.Action("GuardarTablaEstadistica", "FichaEstadistica")',
                type: "POST",
                  data: JSON.stringify({ objeto: TablaEstadistica }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {

                    $(".modal-body").LoadingOverlay("hide");



                    if (TablaEstadistica.IdTabEstadistica == 0) {

                        if (data.resultado != 0) {
                            debugger;
                            cambiar();

                            /*$("#txtIdFichaEvolucionMedica2").val($("#txtHojaNo").val());*/
                            // para poder saber cual es el id usuario
                            $("#btBuscar2").click();
                            //Tratamiento.IdTablaTratamiento = data.resultado;
                            //tabladata.row.add(Tratamiento).draw(false);
                            $("#FormUsuario").modal("hide");

                        } else {
                            $("#mensajeError").text(data.mensaje);
                            $("#mensajeError").show();
                        }


                    } else {

                        if (data.resultado) {
                          /*  tabladata.row(filaSeleccionada).data(TablaEstadistica).draw(false);*/

                            $("#btBuscar2").click();
                           /* filaSeleccionada = null;*/
                            $("#FormUsuario").modal("hide");

                        } else {
                            $("#mensajeError").text(data.mensaje);
                            $("#mensajeError").show();
                        }
                    }

                  },
                  error: function (error) {
                      $(".modal-body").LoadingOverlay("hide");
                      $("#mensajeError").text("Error Ajax");
                      $("#mensajeError").show();
                  },
                  beforeSend: function () {
                      $(".modal-body").LoadingOverlay("show", {
                          imageResizeFactor: 2,
                          text: "Cargando...",
                          size: 14
                      })
                  }

            });

        }


             function mostrar()
        {
             var nuevaurl = '@Url.Action("ListarTablaEstadistica", "FichaEstadistica")' +
                 "?FechaRegistro=" + $("#txtFecha").val()
            tabladata.ajax.url(nuevaurl).load();
        }

           var Url = '@Url.Action("ListarTablaEstadistica", "FichaEstadistica")' +
               "?FechaRegistro=" + $("#txtFecha").val() ,


               tabladata = $("#tablaEstadistica").DataTable({
                   "paging": false,
                   "searching": false, // Esto desactiva el buscador

                   responsive: true,
                   ordering: false,
                   "info": false,
                   "ajax": {
                       url: Url,
                       type: "GET",
                       dataType: "json"
                   },
                   "columns":
                       [

                           { "data": "no" },
                           { "data": "Nombre" },
                           { "data": "IdHistorialClinica" },
                           { "data": "Edad" },
                           { "data": "Sexo" },
                           { "data": "Procedencia" },
                           { "data": "Consulta" },
                           { "data": "Diagnostico" },
                           { "data": "Comentario" },
                           { "data": "ConsTras" },
                           { "data": "RaOrtesis" },




                            {
                                "defaultContent": ' <button type="button" class="btn btn-outline-secondary btn-sm btn-editar"><i class="fas fa-pen"></i></button>' +
                                    ' <button type="button" class="btn btn-outline-dark btn-sm ms-2 btn-eliminar"><i class="fas fa-trash"></i></button>',
                                "orderable": false,
                                "searchable": false,
                                "width": "90px"
                            }
                        ],
                        "language": {
                            "url": "https://cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json"
            },
            retrieve: true,
            paging: false
        });
            $.fn.dataTable.ext.errMode = 'throw';


        function abrilModal(json) {
            /*txtIdEstadistica2 txtNo cboHistorial cboConsulta txtDiagnostico txtComentario cboConsTral*/

                 $("#txtIdTabEstadistica").val(0);
            $("#txtNo").val(0);
            $("#cboHistorial").val($("#cboHistorial option:first").val());
            $("#cboConsulta").val("");
                $("#txtDiagnostico").val("");
            $("#txtComentario").val("");
            $("#cboConsTral").val("");
            $("#RaOrtesis").val("");

            debugger;



            $("#mensajeError").hide();


            if (json != null) {

                $("#txtIdTabEstadistica").val(json.IdTabEstadistica);
                $("#txtNo").val(json.no);
                $("#cboHistorial").val(json.IdHistorialClinica);
                $("#txtDiagnostico").val(json.Diagnostico);
                $("#cboConsulta").val(json.Consulta);
                $("#cboConsTral").val(json.ConsTras);
                $("#RaOrtesis").val(json.RaOrtesis);
                $("#txtComentario").val(json.Comentario);
            }

            $("#FormUsuario").modal("show");
        }










   /*     txtIdEstadistica txtIdEstadistica2*/
        function cambiar() {
            var ci = document.getElementById('txtIdEstadistica').value;
            document.getElementById('txtIdEstadistica2').value = ci;
        }

    function Actualizar() {

        var FichaEstadistica = {
            IdEstadisticaDiaria: $("#txtIdEstadistica").val(),
            oEmpleado: {
                IdEmpleado: $("#cboEmpleado2 option:selected").val(),
                PrimerNombre: $("#cboEmpleado2 option:selected").text(),
                PrimerApellido: $("#cboEmpleado2 option:selected").text()
            },

            FechaRegistro: $("#txtFecha").val(),
            HoraInicio: $("#txtInicio").val(),
            HoraFin: $("#txtFin").val()


}

    jQuery.ajax({
        url: '@Url.Action("ActualizarEstastica", "FichaEstadistica")',
        type: "POST",
        data: JSON.stringify({ objeto: FichaEstadistica }),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {
            $(".modal-body").LoadingOverlay("hide");
            debugger;

            if (data.resultado != 0) {


                cambiar();
                //// Set the values of txt1oAPELLIDO and txtNOMBRE
                //$("#txt1oAPELLIDO").val($("#txtPrimerApellidob").val());
                //$("#txtNOMBRE").val($("#txtPrimerNombreb").val());

                ////para poder saber cual es el id usuario
                $("#btBuscar2").click();


                // La inserción fue exitosa.
                // Puedes realizar cualquier acción adicional que desees aquí.
                // Por ejemplo, borrar los campos del formulario o mostrar un mensaje de éxito.
                swal("Los cambios se guardaron con exito", "success");

            } else {
                swal("Error", data.mensaje, "error")
            }
        },
        error: function (error) {
            $(".modal-body").LoadingOverlay("hide");
            $("#mensajeError").text("Error Ajax");
            $("#mensajeError").show();
        },
        beforeSend: function () {
            $(".modal-body").LoadingOverlay("show", {
                imageResizeFactor: 2,
                text: "Cargando...",
                size: 14
            });
        }
    });
        }


        ///Sirve para asignar el historial clinica a la ficha evolucion tecnica

          $(function ()
          {
              $("#btBuscar2").on("click", function () {



                jQuery.ajax({
                    url: '@Url.Action("VistaEstadisctica", "FichaEstadistica")' +
                        "?FechaRegistro=" + $("#txtFecha2").val() ,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        debugger;

                        var ob = data.resultado;
                  /*     txtApellidos txtNombres txtHistoriaclinicaNo txtEdad cboSexo2 txtDiagnosticos*/
                        $("#txtIdEstadistica").val(ob.IdEstadisticaDiaria),


                            $("#txtFecha").val(ob.FechaRegistro),
                            $("#txtInicio").val(ob.horaInicio),
                            $("#txtFin").val(ob.horaFin),
                            $("#cboEmpleado2").val(ob.oEmpleado.IdEmpleado)



                        mostrar();
                        cambiar();
                    }

                });

            });

        }
        )



function Guardar() {
    debugger;
    var Estadistica = {

        oEmpleado: {
            IdEmpleado: $("#cboEmpleado2 option:selected").val(),
            PrimerNombre: $("#cboEmpleado2 option:selected").text(),
            PrimerApellido: $("#cboEmpleado2 option:selected").text()
        },

        FechaRegistro: $("#txtFecha").val(),
        HoraInicio: $("#txtInicio").val(),
        HoraFin: $("#txtFin").val()

    }

    jQuery.ajax({
        url: '@Url.Action("GuardarEstadistica", "FichaEstadistica")',
        type: "POST",
        data: JSON.stringify({ objeto: Estadistica }),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data) {
            $(".modal-body").LoadingOverlay("hide");
            debugger;

            if (data.resultado != 0) {
                cambiar();
                //// Set the values of txt1oAPELLIDO and txtNOMBRE
                //$("#txtIdEstadistica").val(data.resultado);
                //    /// txtIdFichaEstudio
                // //para poder saber cual es el id usuario
                //$("#btBuscar2").click();
                LimpiarFormulario();


                // La inserción fue exitosa.
                // Puedes realizar cualquier acción adicional que desees aquí.
                // Por ejemplo, borrar los campos del formulario o mostrar un mensaje de éxito.
                swal("Se guardo con exito, con fecha " + Estadistica.FechaRegistro, "success");

            } else {
                swal("Error", data.mensaje, "error")
            }
        },
        error: function (error) {
            $(".modal-body").LoadingOverlay("hide");
            $("#mensajeError").text("Error Ajax");
            $("#mensajeError").show();
        },
        beforeSend: function () {
            $(".modal-body").LoadingOverlay("shsow", {
                imageResizeFactor: 2,
                text: "Cargando...",
                size: 14
            });
        }
    });
        }





             ////PARA LISTAR USUARIOS DE HISTORIAL CLINICO
              jQuery.ajax({
            url: '@Url.Action("ListarHistorialClinicas", "HistoClinico")',
            type: "GET",
            data: null,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
              success: function (data) {
                  debugger;
                  console.log(data)

                  $("<option>").attr({ "value": "0", "disabled": "true" }).text("Seleccionar").appendTo("#cboHistorial");
                $.each(data.data, function (index, item) {

                    $("<option>").attr({ "value": item.IdHistorialClinica }).text(item.IdHistorialClinica+' '+item.Nombre + ' ' + item.MotivoConsulta).appendTo("#cboHistorial");
                })
            },
            error: function (error) {
                console.log(error)
            }
          });


        ////PARA LISTAR MEDICOS
              jQuery.ajax({
            url: '@Url.Action("ListarEmpleados", "Admin")',
            type: "GET",
            data: null,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
              success: function (data) {
                  debugger;
                  console.log(data)
                  
                  $("<option>").attr({ "value": "0", "disabled": "true" }).text("Seleccionar").appendTo("#cboEmpleado2");
                $.each(data.data, function (index, item) {

                    $("<option>").attr({ "value": item.IdEmpleado }).text(item.PrimerNombre + ' ' + item.PrimerApellido).appendTo("#cboEmpleado2");
                })
            },
            error: function (error) {
                console.log(error)
            }
          });
    </script>


}


